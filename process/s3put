#!/bin/bash

set -e

usage()
{
  echo "Usage: s3put -b [bucket] -f [folder] -c [content-type] file1 file2 ..."
}

while getopts ":b:f:c:" opt; do
  case $opt in
    b)
      BUCKET=$OPTARG
      ;;
    f)
      FOLDER=$OPTARG
      ;;
    c)
      CONTENT_TYPE=$OPTARG
      ;;
    \?)
      echo "Invalid option: -$OPTARG" >&2
      exit 1
      ;;
    :)
      echo "Option -$OPTARG requires an argument." >&2
      exit 1
      ;;
  esac
done

if [ -z "$BUCKET" ]; then
  usage
  exit 1
fi

[ ! -z "$FOLDER" ] && FOLDER=${FOLDER%/}
[ -z "$CONTENT_TYPE" ] && CONTENT_TYPE="binary/octet-stream"

shift $((OPTIND-1))

while [ $# -gt 0 ]
do
  FILE=$1
  FILENAME="${FILE##*/}"

  MD5SUM=$(openssl dgst -md5 -binary "$FILE" | openssl enc -base64)

  if [ -z "$FOLDER" ]; then
    KEY=$FILENAME
  else
    KEY=$FOLDER/$FILENAME
  fi
  
  aws s3api put-object --bucket "$BUCKET" --key "$KEY" --body "$FILE" --content-type $CONTENT_TYPE --content-md5 $MD5SUM >>/dev/null

  echo "$BUCKET/$KEY"

  shift
done

exit 0

